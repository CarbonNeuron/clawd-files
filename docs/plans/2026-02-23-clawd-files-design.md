# Clawd Files v2 â€” Design Document

**Date:** 2026-02-23
**Status:** Approved

---

## Overview

Clawd Files is a file hosting platform built for LLMs as first-class users. Think GitHub repos, but for temporary/permanent file sharing with API-first design. Buckets (like repos) hold files and folders, are owned by named API keys, and expire automatically.

**Branding:** "Designed by Clawd ðŸ¦€" â€” ðŸ¦€ favicon.

---

## Tech Stack

| Layer | Choice |
|---|---|
| Framework | Next.js 16 (App Router) |
| Language | TypeScript (strict) |
| Styling | Tailwind CSS v4 + shadcn/ui |
| Database | SQLite via Drizzle ORM + better-sqlite3 |
| File storage | Local filesystem |
| Syntax highlighting | Shiki (server-side) |
| Deployment | Docker (single container) |

---

## Data Model

### `api_keys`
| column | type | notes |
|---|---|---|
| `key` | text PK | SHA-256 hash of raw key |
| `name` | text | label, e.g. "SQL Buddy" |
| `created_at` | integer | unix timestamp |
| `last_used_at` | integer | updated on each auth |

Raw key shown once on creation, never stored.

### `buckets`
| column | type | notes |
|---|---|---|
| `id` | text PK | 10-char nanoid |
| `name` | text | display name |
| `owner` | text | `api_keys.name` |
| `description` | text | nullable |
| `for_field` | text | nullable â€” displayed as "by X, for Y" |
| `created_at` | integer | unix timestamp |
| `expires_at` | integer | nullable = never expires |

### `files`
| column | type | notes |
|---|---|---|
| `id` | integer PK | autoincrement |
| `bucket_id` | text FK | cascade delete |
| `path` | text | e.g. `reports/q1.csv` |
| `size` | integer | bytes |
| `mime_type` | text | detected on upload |
| `created_at` | integer | unix timestamp |

Unique constraint on `(bucket_id, path)` â€” re-uploading a path replaces the file.

### File storage on disk
```
$DATA_DIR/
  db.sqlite
  files/
    {bucket_id}/
      {path...}
```

---

## Authentication

### Admin
- API endpoints: `Authorization: Bearer $ADMIN_API_KEY`
- Dashboard page: HMAC-SHA256 signed token in query param (`/admin?token=...`)
  - Token = HMAC-SHA256(`expires_at`, secret=`ADMIN_API_KEY`)
  - Valid for 24 hours
  - Generated by `GET /api/admin/dashboard-link`
  - No session, no cookies â€” verify HMAC + timestamp on each request

### LLM API Keys
- `Authorization: Bearer <raw_key>`
- On each request: SHA-256 hash the key, look up in `api_keys`, update `last_used_at`
- Scoped to own buckets only

### Route Protection

| Route | Access |
|---|---|
| `POST /api/keys` | Admin only |
| `GET/DELETE /api/keys` | Admin only |
| `GET /api/admin/dashboard-link` | Admin only |
| `/admin?token=...` | Valid HMAC token |
| `POST /api/buckets` | Any valid API key |
| `GET /api/buckets` | API key (own buckets only) |
| `GET/PATCH/DELETE /api/buckets/:id` | Owner key or admin |
| `POST /api/buckets/:id/upload` | Owner key or admin |
| `DELETE /api/buckets/:id/files` | Owner key or admin |
| `/{bucket_id}/...` (view/download) | Public â€” no auth |

---

## Content Negotiation & Routing

### Middleware (`src/middleware.ts`)
Runs on every request matching `/:bucket/:path+` (excluding `/raw/`, `/api/`, `/admin`, `/docs`):
- `Accept` does **not** include `text/html` â†’ rewrite to `/raw/{bucket}/{path}`
- Otherwise â†’ pass through to `page.tsx` for HTML preview

The `/raw/` prefix is an explicit override that always returns raw bytes regardless of `Accept`.

### Route Map
```
src/app/
  page.tsx                              # Landing page
  docs/
    page.tsx                            # API docs (interactive, Stripe-style)
    api.md/route.ts                     # Raw markdown at /docs/api.md
  admin/
    page.tsx                            # Dashboard (HMAC token-gated)
  [bucket]/
    page.tsx                            # Bucket view (file tree + README)
    [...path]/
      page.tsx                          # File preview (HTML)
  raw/
    [bucket]/[...path]/
      route.ts                          # Always raw â€” streams file bytes
  api/
    keys/route.ts                       # POST, GET
    keys/[key]/route.ts                 # DELETE
    buckets/route.ts                    # POST, GET
    buckets/[id]/route.ts               # GET, PATCH, DELETE
    buckets/[id]/upload/route.ts        # POST multipart
    buckets/[id]/files/route.ts         # DELETE
    buckets/[id]/summary/route.ts       # GET plain-text (LLM-friendly)
    admin/dashboard-link/route.ts       # GET
  llms.txt/
    route.ts                            # GET /llms.txt
```

### Cache Headers (raw file responses)
- Never-expiring bucket: `public, max-age=31536000, immutable`
- Expiring bucket: `public, max-age={seconds_remaining}`
- Expired resource: `no-store`, 410 Gone

### Expiry Cleanup
Primary: `instrumentation.ts` (`register()` export) starts a `setInterval` every 15 minutes on server startup. Deletes expired buckets from DB (cascade deletes `files` rows) and removes their directories from `$DATA_DIR/files/`.

Fallback (if instrumentation proves unreliable): Shell loop in Docker entrypoint (`while true; do node cleanup.js; sleep 900; done`) running alongside the Next.js process.

---

## Visual Design

### Concept: "Abyssal Terminal"
Deep-sea research station aesthetic. Dark as the ocean floor, bioluminescent accents cutting through the dark. Technical precision meets oceanic atmosphere.

### Color Palette
```css
--bg:             #06090f   /* near-black, cold blue tint */
--surface:        #0d1520   /* deep navy cards */
--surface-hover:  #111d2c
--border:         #1a2d40
--accent:         #22d3ee   /* bioluminescent cyan â€” primary CTA, links */
--accent-warm:    #f97316   /* crab orange â€” secondary, expiry, warnings */
--text:           #e2e8f0
--text-muted:     #64748b
```

### Typography
- **Headings:** Instrument Serif â€” elegant, unexpected for a dev tool
- **UI/body:** Geist Mono â€” precise, technical
- **Code blocks:** JetBrains Mono

### Components
- shadcn/ui for all base components (`Card`, `Table`, `Badge`, `Button`, `Dialog`, etc.)
- CSS variable overrides to apply Abyssal Terminal palette to shadcn theme
- Subtle noise texture on backgrounds
- Cyan glow on interactive elements: `box-shadow: 0 0 12px #22d3ee33`
- File type badges in amber (`--accent-warm`)
- ðŸ¦€ in footer glows faintly on hover

### Syntax Highlighting
Shiki runs server-side (zero client bundle cost). Used for:
- Code/text file previews (`.js`, `.ts`, `.py`, `.sql`, `.sh`, `.json`, `.yaml`, etc.)
- Markdown code blocks inside `.md` files
- Curl examples on `/docs` page

Theme: custom Shiki theme tuned to the Abyssal Terminal palette.

---

## File Preview Types

| Type | Preview |
|---|---|
| `.md` | Rendered markdown + Shiki code blocks. Toggle between rendered/raw. |
| text/code | Shiki syntax-highlighted code view |
| `.csv` | Sortable table |
| images | Inline `<img>` |
| `.mp4`, `.webm` | HTML5 `<video>` |
| `.mp3`, `.wav`, `.ogg` | HTML5 `<audio>` |
| other | Download prompt with file icon + metadata |

All preview pages show: filename, size, MIME type, expiry, bucket link, download button, raw button, curl command.

---

## API Conventions

### Response Shape
All responses include `url`, `api_url` (and `raw_url` for files):
```json
{
  "id": "aBcD1234eF",
  "name": "q1-reports",
  "owner": "SQL Buddy",
  "for": "Carbon",
  "created_at": 1708700000,
  "expires_at": 1709304800,
  "url": "https://clawd.example.com/aBcD1234eF",
  "api_url": "https://clawd.example.com/api/buckets/aBcD1234eF"
}
```

### Error Shape
```json
{
  "error": "Bucket not found",
  "hint": "Check the bucket ID in the URL. Buckets expire â€” it may have been deleted."
}
```

### LLM-Friendly Endpoints
- `GET /api/buckets/:id/summary` â€” plain-text bucket summary (name, owner, file listing, README)
- `GET /llms.txt` â€” machine-readable platform overview (llms.txt convention)
- `GET /docs/api.md` â€” full API reference as raw markdown

---

## Environment Variables

```
ADMIN_API_KEY=        # Required
DATA_DIR=./data       # SQLite DB + file storage root
BASE_URL=             # Public URL (for OG tags, API responses)
PORT=3000
```

---

## Pages

| Page | Route | Notes |
|---|---|---|
| Landing | `/` | Branding, feature overview, link to docs. No bucket listing. |
| Bucket view | `/:bucket_id` | File tree, README, metadata bar |
| File preview | `/:bucket_id/*path` | Content-negotiated |
| Raw file | `/raw/:bucket_id/*path` | Always raw |
| Admin dashboard | `/admin?token=...` | HMAC-gated |
| API docs | `/docs` | Interactive, Stripe-style |

---

## Priority Order

1. API (keys + buckets + file upload/download) â€” foundation
2. File preview pages with Shiki syntax highlighting
3. Bucket page with file tree + README rendering
4. Admin dashboard
5. OG meta tags
6. Polish (animations, ZIP download)

---

## Docker

Single container. `DATA_DIR` mounted as a volume. `ADMIN_API_KEY`, `BASE_URL`, `PORT` set via environment. Instrumentation hook handles cleanup; shell loop fallback available in entrypoint if needed.
